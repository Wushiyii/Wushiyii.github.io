---
title: Mysql使用规范
date: 2019-11-17 11:43:05
tags: [Mysql,workflow]
categories: Mysql
---

为保障业务稳定，降低发生数据库故障概率等原因，尽量遵守以下规范。

<!-- more -->

### 一、基础规范

1. 为应对主备切换，代码里对DB操作必须要有连接失败重连机制
2. 业务上线前，大表应提前规划好分库分表方案，单表数据量原则上控制在1千万以内
3. 历史数据要尽早确定归档方案，线上只保留业务所需数据
4. 禁止数据库中存储图片、文件等大对象数据，日志类的数据可存放在`elasticsearch`。大对象放到`OSS`上，数据库中存储它的路径
5. 避免使用触发器、自定义函数、存储过程
6. 禁止在数据库中存储明文密码，应把密码加密后存

### 二、SQL查询规范

1. 禁止用select *，查询哪几个字段就select 这几个字段
2. SQL语句不可以出现隐式转换，比如 `select id from 表 where id='1'`
3. limit分页注意效率,不能使用`offset`非常大的`limit`，`limit`越大，效率越低。改写示例: `select id from limit 10000, 10 => select id from t where id > 10000 limit10`
4. 如排序需求，应去除sql中的排序，例如去除top n查询中的 `order by id desc `、`order by null `
5. sql语句尽可能简单，大的sql想办法拆成小的sql语句
6. 线上业务应避免关联查询，特别是大表关联，尽可能使用简单查询
7. 尽量减少与数据库的交互次数，避免无效查询
8. 使用`union all`替代`union`
9. 减少sql语句中无效条件、无效排序
10. sql中使用到`OR`的改写为用` IN()`
11. `in`里面数字的个数建议控制在1000以内
12. 使用`exist`代替`in`，`exist`在一些场景查询会比`in`快
13. 能不用`NOT IN`就不用`NOT IN`，坑多
14. 禁止使用前缀是`%`的`like`查询，避免使用反向查询，如`not in/like`
15. sql上线前必须使用`explain`分析，避免在`extra`列出现:`Using filesort`、`Using temporary`， 核心业务单个sql 扫描行数原则上应低于5000行

### 三、SQL数据更新规范

1. 原则上单个实例每秒更新/删除 不超过2000条，每条语句不超过1000条记录
2. 对数据的更新要打散后批量更新，不要一次更新/删除太多数据
3. 禁止大事务, 事务要简单，整个事务的时间尽可能短
4. 禁止在框架、配置层面关闭`autocommit`,  如需事务支持，应显示地开启事务，事务关闭后须及时提交
5. 禁单条SQL语句同时更新多个表, 危险

### 四、库、表、字段及索引设计规范 

详见[表、字段、索引设计规范](表、字段、索引设计规范.html)

