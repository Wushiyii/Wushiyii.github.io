---
title: Dubbo服务的导出与引入
date: 2020-08-28 16:40:11
tags: [distribute、framework、dubbo]
categories: framework
---
Dubbo的服务是怎么创建的？消费端又是怎么引入服务呢？

<!-- more -->

Dubbo 服务导出过程始于 Spring 容器发布刷新事件(`Refresh`)，Dubbo 在接收到事件后，会立即执行服务导出逻辑。

整个逻辑大致可分为三个部分，第一部分是前置工作，主要用于检查参数，组装 URL。第二部分是导出服务，包含导出服务到本地 (JVM)，和导出服务到远程两个过程。第三部分是向注册中心注册服务，用于服务发现。

### 导出Dubbo服务

1. ##### 参数校验及URL装配

在Spring容器的各个启动阶段，Spring会进行当前阶段事件的广播。在Spring进行容器刷新的事件，dubbo通过接受事件开始Dubbo的启动。具体的方法入口，可以见ServiceBean.onApplicationEvent方法

```java
 @Override
    public void onApplicationEvent(ContextRefreshedEvent event) {
        if (isDelay() && !isExported() && !isUnexported()) {
            if (logger.isInfoEnabled()) {
                logger.info("The service ready on spring started. service: " + getInterface());
            }
            export();
        }
    }
```

参数检查这一步骤主要进行的是：

- 检测服务interfaceName是否为空
- 检测provider是否为空，为空则创建
- 检测服务是否为泛化类型，若不是则对服务的interfaceClass、methd进行校验
- 检测application、registry、protocal等对象是否为空，不为空则创建或者报错

2. ##### 导出服务

- 加载注册中心连接，并组装pid、path、时间戳、protocal参数等
- 根据注册中心连接、protcal、host、port以及额外的parameter等参数组装好URL
- 导出Dubbo服务
  - 根据URL中的scope判断导出到本地或远程
  - 创建Invoker（由ProxyFactory创建，默认使用Javaassist创建）；创建过程主要是通过javaassist生成对应类的各个set、get、构造函数、字段、方法代码等
  - 导出服务
    - 创建DubboExporter
    - 启动服务器（默认使用netty，也可以使用mina）
  - 获取注册中心地址串、根据URL加载到对应注册中心的实现类Registry
  - 向服务提供者注册表与消费者注册表周注册服务提供者
  - 向注册中心注册服务、创建服务监听器、向注册中心进行订阅 override 数据

3. ##### 注册服务

- 通过URL获取对应的注册中心实现类（默认为zookeeper）

- 通过*CuratorZookeeperTransporter*创建Zookeeper客户端；添加zookeeper状态监听器
- 在zookeeper中创建服务节点，节点路径如：*/dubbo/org.apache.dubbo.DemoService/providers/dubbo%3A%2F%2F127.0.0.1......



至此，服务导出完成，主要包括`配置检测`，`URL 组装`，`Invoker 创建`、`导出服务`以及`注册服务`等等



