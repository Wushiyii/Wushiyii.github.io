---
title: 深入理解JVM（四） --- 栈帧结构
date: 2019-09-08 15:40:34
tags: [JAVA,JVM]
categories: JAVA

---

The structure of Frame

<!-- more -->

所有的Java虚拟机的执行引擎都是一致的：输入的是字节码文件，处理过是字节码解析过程，输出的是执行结果。

### 运行时的栈帧结构

栈帧（`Stack Frame`）是用于支持虚拟机进行方法调用与执行的数据结构，它是虚拟机运行时数据区中的虚拟机栈（`Virtual Machine Stack`）中的栈元素。栈帧存储了方法的局部变量表、操作数栈、动态连接、方法返回地址等信息。每个方法从调用开始到执行完成都对应一个栈帧在虚拟机中的入栈与出栈过程。

![img](https://user-gold-cdn.xitu.io/2018/8/13/16531ddd69f40e77?imageslim)

#### 局部变量表

局部变量表（`Local Variable Table`）是一组变量值存储空间，由于存放方法参数和方法局部变量。局部变量表的容量以变量槽（Variable Slot）为最小单位。一个Slot可以存放一个32位以内的数据类型，Java中占用32位及以内的数据类型有boolean、byte、char、short、int、float、referecne和returnAddress 这8种。其中`referecn`表示一个对一个对象实例的引用，虚拟机可以通过此引用，做到如下两单：

- 通过此引用直接或间接查找到对象在Java堆中数据存放的其实地址索引
- 通过此引用直接或间接查找到对象所属数据类型在方法区中存储的类型信息

对于64位数据，虚拟机会以高位对齐的方式为其分配两个连续的Slot空间，不过由于局部变量表建立在现场的堆栈上，属于线程私有，所以无论连续两个Slot是否为原子操作，都不会引起数据安全问题。

为了尽可能节省栈帧空间，局部变量表中的Slot是可以重用的，也就是说当PC计数器的指令指已经超出了某个变量的作用域（执行完毕），那这个变量对应的Slot就可以交给其他变量使用。 

- 优点 ： 节省栈帧空间。 
- 缺点 ： 影响到系统的垃圾收集行为。（如大方法占用较多的Slot，执行完该方法的作用域后没有对Slot赋值或者清空设置null值，垃圾回收器便不能及时的回收该内存。）



#### 操作数栈

操作数栈（Operand Stack）也称为操作栈，同局部变量表一样，操作数栈的最大深度也是在编译时写入道Code熟悉中的。操作数栈的每一个元素可以是任意的Java数据类型。

当一个方法刚开始执行时，会有各种字节码指令往操作数栈中写入与提取内容，也就是出栈、如栈操作。例如进行一个整数加法操作，首先会将栈顶两个int值先出栈，进行iadd指令，再将结果入栈。



#### 动态连接

每个栈帧都包含一个指向运行时常量池中该栈帧所属方法的引用，持有这个引用是为了支付方法调用过程中的动态连接（Dynamic Linking）。Class文件的常量池中有着大量的符号引用，在类加载阶段中的解析阶段会将符号引用转为直接引用，这种转化也称为`静态解析`。这些符号的另外的一部分将在每一次运行时期转化为直接引用。这部分称为`动态连接`。



#### 方法返回地址

当一个方法开始执行后，只有两种方式可以退出方法：

- 执行引擎遇到任意一个方法返回的字节码指令，这种退出方法称为正常完成出口（Normal Method Invocation Completion）

- 在方法执行过程遇到异常，并且异常没有在方法体中进行处理，无论是虚拟机内部的异常还是代码中使用athrow字节码指令产生的异常，只要在本方法的异常表中没有搜索到匹配的异常处理器，就会导致方法退出，并且不会返回上层调用者任何返回值。这种退出方法的方式称为异常完成出口（Abrupt Method Invocation Completion）

无论如何退出，都需要返回到方法被调用的位置，程序才能继续执行。一般来说，方法正常退出时，调用方的PC计数器的值可以作为返回地址；而方法异常退出时，返回地址需要通过异常处理器表来确定的。


